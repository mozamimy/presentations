<!-- $theme: gaia -->

# Ruby DSL :gem: × SSH config :page_with_curl: = Nymphia !!

## [@mozamimy](https://mozami.me/)

---
<!-- page_number: true -->

# :pencil2: Configure everyday

- vimrc
- bashrc
- hako_apps
- Apache rewrite rules
- Fluend
- Sendmail
- etc...

---
<!-- page_number: true -->

# :scream: SSH config :scream:

---
<!-- page_number: true -->

# :thought_balloon: Why so difficult?

- 気を抜くと SSH config が破滅してる
	- 構造的に書けるようになっていない
- ご家庭や仕事のインフラが混じると最悪
	- 基本フラットに 1 ファイルとして書く
- 他人のファイル読むの難しい
- とにかく冗長

---
<!-- page_number: true -->

# :question: What is Nymphia?

```ruby
identity_file :private, '~/.ssh/id_rsa.1'

my_server_port = 4321

host 'alice', 'my server on VPS' do
  hostname 'alice.example.com'
  user 'alice'
  port my_server_port
  use_identify_file :private
end
```

```
Host alice
  Hostname alice.example.com
  User alice
  Port 4321
  IdentityFile ~/.ssh/id_rsa.1
```

---
<!-- page_number: true -->

# :thought_balloon: Motivation

- Ruby の DSL を作ってみたかった
- SSH config に秩序をもたらしたい
- 構造化して DRY にしたい
- ファイルを分けて管理したい
- Ruby を使った構成管理ツールに組み込みやすそう

---
<!-- page_number: true -->

# 簡単なつかいかた (雰囲気)

---
<!-- page_number: true -->

# :gem: Install

```sh
$ gem install nymphia
```

# :pencil2: CLI

```sh
$ nymphia --help
nymphia
    -f, --file=FILE         Your DSL code file
    -o, --output=FILE       Output file (default: stdout)
```

---
<!-- page_number: true -->

# :rabbit: Basis

## :memo: source

```ruby
identity_file :private, '~/.ssh/id_rsa.1'

my_server_port = 4321

host 'alice', 'my server on VPS' do
  hostname 'alice.example.com'
  user 'alice'
  port my_server_port
  use_identify_file :private
end
```

---
<!-- page_number: true -->

# :rabbit: Basis

## :memo: compiled

```plain
#
# This config is generated by Nymphia 0.1.1
#

# my server on VPS
Host alice
  Hostname alice.example.com
  User alice
  Port 4321
  IdentityFile ~/.ssh/id_rsa.1
```

---
<!-- page_number: true -->

# :hocho: Splitting files

```ruby
identity_file :private, '~/.ssh/id_rsa.1'

host 'alice', 'my server on VPS' do
  hostname 'alice.example.com'
  user 'alice'
  port 4321
  use_identify_file :private
end

load 'other_nymphia_file.nym.rb'
```

- `load` で別ファイルを読み込める
- 単一の config として出力される

---
<!-- page_number: true -->

# :bust_in_silhouette: Proxy and Gateway

- ナマの SSH config は全てが `Host`
	- proxy や gateway として使うホストをコードレベルでわかるようにしたい

---
<!-- page_number: true -->

# :bust_in_silhouette: Proxy

```ruby
identity_file :company_proxy, '~/.ssh/id_rsa.company.gw'

proxy 'awsproxy.company.apne1' do
  hostname 'gw.apne1.example.com'
  user 'alice'
  port 19822
  use_identify_file :company_proxy

  # SOCKS proxy
  dynamic_forward 23921

  # ssh tunnels
  local_forward 'mysql-server', {
    'localhost' => 13306,
    'mysql.apne.aws.example.com' => 3306,
  }
end
```

---
<!-- page_number: true -->

# :bust_in_silhouette: Proxy

- `host` と基本は同じ
	- ブロック内は `host` と同様に書ける
- `proxy` 内では `local_foward` というメソッドが使える
	- `LocalForward` をハッシュできれいに書ける

---
<!-- page_number: true -->

# :bust_in_silhouette: Proxy

## :memo: compiled

```plain
#
# This config is generated by Nymphia 0.1.1
#

Host awsproxy.company.apne1
  Hostname gw.apne1.example.com
  User alice
  Port 19822
  IdentityFile ~/.ssh/id_rsa.company.gw
  DynamicForward 23921
  LocalForward localhost:13306 mysql.apne.aws.example.com:3306
```

---
<!-- page_number: true -->

# :customs: Gateway

## define a gateway

```ruby
identity_file :company, '~/.ssh/id_rsa.company'
identity_file :company_gateway, '~/.ssh/id_rsa.company.gw'

gateway 'company.gateway' do
  hostname 'gw.example.com'
  user 'alice'
  port 19822
end
```

- `host` の代わりに `gateway` でゲートウェイを定義
- ブロック内は普通の `host` とおなじ

---
<!-- page_number: true -->

```
group 'company.ap-northeast-1' do
  use_gateway 'company.gateway'

  default_params do
    check_host_ip 'no'
    strict_host_key_checking 'no'
    user 'alice'
    port 9822
    use_identify_file :company, :company_gateway
  end

  host '*.apne.aws.example.com'

  host 'alice.apne.aws.example.com' do
    hostname '10.16.16.16'
    user 'white_rabbit'
    port 7777
  end
end
```
---
<!-- page_number: true -->

# :customs: Gateway

- `use_gateway` で先に定義した gateway をグループに適用できる
- `default_params` でグループ内のホストにデフォルトで適用するパラメータをまとめて書いておける
- `default_params` は上書き可能

---
<!-- page_number: true -->

# :customs: Gateway

```plain
#
# This config is generated by Nymphia 0.1.1
#

Host company.gateway
  Hostname gw.example.com
  User alice
  Port 19822

Host *.apne.aws.example.com
  CheckHostIp no
  StrictHostKeyChecking no
  User alice
  Port 9822
  IdentityFile ~/.ssh/id_rsa.company
  IdentityFile ~/.ssh/id_rsa.company.gw
  ProxyCommand ssh company.gateway -q -W %h:%p
```

---
<!-- page_number: true -->

# :customs: Gateway

```plain
Host alice.apne.aws.example.com
  CheckHostIp no
  StrictHostKeyChecking no
  IdentityFile ~/.ssh/id_rsa.company
  IdentityFile ~/.ssh/id_rsa.company.gw
  ProxyCommand ssh company.gateway -q -W %h:%p
  Hostname 10.16.16.16
  User white_rabbit
  Port 7777
```

---
<!-- page_number: true -->

# :muscle: Future issues

- 構文解析して SSH config → Ruby に変換
	- ほんとはここまでやりたかった.. :sob:
	- [Treetop](http://treetop.rubyforge.org/) ? Racc ? Racc のほうがよさげ
- OpenSSH の比較的新しい機能に追従する
	- `ProxyJump` とか `Include` とか..
- コンパイルなしに SSH できる `$ nymphia ssh` みたいなサブコマンドを作る
- 簡易プロビジョニング
	- ホームディレクトリ以下に `.bashrc` 置くとか